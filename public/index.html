<html>
<head>
  <title>CommandStar</title>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    var userNotes = {
    };
    var addChatRow = function( who, what, when ) {
      d = new Date( when );
      niceDate = '';
      niceDate += d.getHours() + ':' + ( "0" + d.getMinutes() ).slice( -2 );
      $('#chatlog').append(
        '<tr>'+
          '<td>' + niceDate + '</td>' +
          '<td>' + who + '</td>' +
          '<td>' + what + '</td>' +
        '</tr>'
      );
      // keep chat scrolled to bottom
      $('#chatlog').scrollTop( 9999 );
    }
    var setPlayersOnline = function( players ) {
      $('#players li').remove();
      $.each( players, function( key, val ) {
        note = val;
        if( userNotes[ val ] ) {
          note += " ("+userNotes[val]+")";
        }
        $('#players').append('<li>'+note+'</li>');
      });
    };

    var apiBase = '';
    var socket = io.connect(apiBase);
    socket.on('chat',function(data){
      addChatRow( data.who, data.what, data.when );
    });
    socket.on('playerCount',function(data){
      setPlayersOnline( data.playersOnline );
    });
    $(document).ready(function(){
      // load server status
      $.get( apiBase + "/server/status", function( data ) {
        setPlayersOnline( data.playersOnline );
      });

      // load chat
      $.get( apiBase + "/server/chat", function( data ) {
        msgs = data.length;
        if( msgs < 10 ) {
          start = 0;
        } else {
          start = msgs - 10;
        }
        for( i = start; i < msgs; i++ ) {
          addChatRow( data[i].who, data[i].what, data[i].when );
        }
      });
    });
  </script>
</head>
<body>
  <h1>Starbound Server</h1>

  <h2>Players Online:</h2>
  <ul id="players">
  </ul>

  <h2>Recent/Live Chat Log</h2>
  <table border="1" cellspacing="0" cellpadding="4" style="width:700px">
    <tbody id="chatlog" style="height: 200px; width: 700px; overflow-y: auto; display:block">
    </tbody>
  </table>

  <h2>API</h2>

  <ul>
    <li><a href="/server/status">Server Status</a></li>
    <li><a href="/server/chat">Server Chat</a></li>
  </ul>
</body>
</html>
